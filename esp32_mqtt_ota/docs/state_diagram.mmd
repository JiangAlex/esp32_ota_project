stateDiagram-v2
    [*] --> WIFI_CONNECT

    WIFI_CONNECT --> NET_CHECK: WiFi connected
    WIFI_CONNECT --> RETRY: WiFi fail

    NET_CHECK --> MQTT_SUB: Internet OK
    NET_CHECK --> RETRY: Internet fail

    MQTT_SUB --> WAIT_OTA: MQTT connected & subscribed
    MQTT_SUB --> RETRY: MQTT connect fail

    WAIT_OTA --> WAIT_OTA: client.loop()\nperiodic publish (update request)
    WAIT_OTA --> PARSE_JSON: MQTT message received

    PARSE_JSON --> OTA_UPDATE: payload contains newer version
    PARSE_JSON --> WAIT_OTA: payload fail
    PARSE_JSON --> RUNNING: already latest

    OTA_UPDATE --> REBOOT: OTA success
    OTA_UPDATE --> RETRY: OTA fail / HTTP error

    RETRY --> WIFI_CONNECT: Retry < 5\ndelay 5s
    RETRY --> RUNNING: Retry >= 5\nenter RUNNING
    RUNNING --> RUNNING: loop()
    REBOOT --> [*]